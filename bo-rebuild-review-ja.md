# 技術選定とディレクトリ構成の振り返り

## はじめに

この記事は、前回私が執筆した新しいアプリケーション構築の技術選定とディレクトリを紹介した以下記事の振り返り記事です。
https://medium.com/shippio/back-office-application-renewal-608ee85b4bc1

アプリケーションの新規構築から約3ヶ月が経過したので、開発・運用してきた中で感じたことを振り返ってみようと思います。

## 技術選定の振り返り

全体的に今のところ「失敗したー」というものはないです。

### TypeScriptの導入

メインで開発をするメンバーの2人とも(私を含めて)TypeScript初心者でしたが、開発スピードをそこまで損ねることなく、TypeScriptで開発できています。
一つの要因としては、メンター(アドバイザー)として入ってもらっている外部のエンジニアさんが、TypeScript経験者だったことがあり、アドバイスを随時もらえたことです。開発中どうしてもわからないときは、一旦`any`で逃げて、その後相談して必ず型をつけるようにしていました。
TypeScriptの導入で感じたメリットはやっぱり、開発中に肩の不一致などのバグを早期発見できることです。
Backendとのデータのやり取りにはApollo Clientを使っているのですが、GraphQL Code Generatorも使い勝手が良くスムーズに開発ができています。
  
### Vite, Vitest

ViteとVitestは、DXの向上に大きく貢献してくれています。
導入に際しても大きな問題はなく、ドキュメントを読むなり、関連の記事を読むなり（ユーザ規模も大きくなっているので、情報が豊富にある）で問題なく運用できています。

### グローバルステート管理について

グローバルステート管理には、React Context API と Reducerを組み合わせて使っています。
ここはライブラリを入れるか悩んだところだったのですが、まずはReact APIで実装してみようということでスタートしました。
今のところ特に問題なく運用できていますが、再レンダリングをなるべく減らすための工夫 (Contextの分割やMemoizeなど)をしたり、それによってコードの可読性が下がってしまったり、ベストではないかなと思っています。
分散管理ができる、Recoilについて興味があるので、どっかのタイミングで試してみたいなと思っています。


## TanStack Table

Tanstack tableはヘッドレスなテーブルライブラリです。
使ってみた感想ですが、初期はそこそこ苦労しました。
ドキュメントにExampleがあって便利なのですが、Get started的な、導入初期のユーザ向けの説明がなく、利用方法について理解するのに少し時間がかかりました。
良かった点としては、ヘッドレスだったのでスタイリングがしやすかったことです。一度テーブルのUIコンポーネントを作ってしまえば、毎回スタイリングしなければいけないというわけでもないです。
Paginationを最近導入したけど、やりやすかった。
Editableなテーブルがサポートされているのが導入の一つの決め手で、次の機能開発で使うつもりだから楽しみ。
  
## CSS Modules

今までのSASS + BEMに比べて、class名のネーミングに悩むことがなったのは良い点です。
最近のCSSの進化がすごいので、もはやPost CSSなどのツールなしでも特に文句はないです。
Component LibraryとしてMUIを使っていて、Dependencyとしてemotionを導入したので、コンポーネントに対して少しのスタイリングしかしない場合などは、全体の見通しを良くするために、tsxファイル内にCSS-in-JSでスタイリングする二刀流にしています。

## dependabot

現行の他アプリケーションでの課題になっていた、PackageのVulnerabilityへの対応が、dependabotを導入したことで、定期的に対応するようになりました。
設定としては、AlertとSecurityのみを有効にしています。
ただ、脆弱性を伴わないパッケージの更新についても、dependabotでの設定こそしていませんが、早めに対応するようにしたいと思います。

## ディレクトリ構成の振り返り

続いて、ディレクトリ構成の振り返りです。

### components

まず、少し苦労したことから振り返ると、`component/model`内で、どのmodelに対応するかに初期は迷う場面がありました。これに関して、開発メンバーと意見を交わす中で、モデルの理解が深まっていくことで、どのmodelに対応するかが明確になってきました。

良かった面では、

- 階層の深さにルールを設けたことで、階層が浅くなった分、並列に並ぶフォルダが多くなりましたが、ファイルの検索では特に問題はありませんし、コンポーネントの一覧性、規律化という意味では、良いと思っています。
- ディレクトリ構成を意識することによって、コンポーネントの分離が促進された。
- ファイルの移動がほぼなくなった。

### サードパーティライブブラリのインターフェース層

サードパーティライブラリのインターフェース層は、`src/lib`に配置しています。
今のところはメリットを享受しているとは言えないですが、今後のライブラリを変更するなど変更が必要になったときの柔軟性を持てるように設計できていると思います。
また、eslintで直接インポートへ警告を出す設定をしているので、新しいメンバーが入ってきた時にも、このルールが守られるような仕組みになっています。

### barrel + Arias を使った直接パスのインポート

barrel + Ariasを使った直接パスのインポートはかなり快適です。
import の部分をコピぺすることも多いかと思いますが、いちいち相対パスへの書き換えが必要なくなったのはかなり快適です。

## 前回以降に追加した技術

前回の記事以降に採用した技術についても触れておきます。

フォームのライブラリとして、react-hook-formを導入しました。
アプリケーションの用件として、フォームが多くあるシステムであるので、フォームの状態管理をライブラリに任せることで、開発効率を上げることができました。
またzodとの組み合わせでバリデーションを実装しているのですが、とても便利です。
zodに関しては、フォームのバリデーションのみでなく、他にも利用方法がありそうなので、今後勉強していきたいと思っています。

## 興味を持っている技術

### Recoil

上記で振り返った通り、Globalなステート管理に課題があるので、分散型のステート管理ができるRecoilには興味があります。
ラーニングカーブがそこそこあると、どこかの記事で読んだので、自分で触ってみて試してみようと思っています。

### Storybook

Storybookで改善できると思っているのは以下の点です。

- サーバー起動したり、フロントエンドアプリケーションを起動したりすることなく、コンポーネントの実装ができる
- a11y のアドオンで、簡単にアクセシビリティ violation が検知できる
- play 関数での UI テスト
- CDD (コンポーネント駆動開発)ができる
- 開発プロセスに集中できる
- UIの組み合わせの網羅性を向上できる
- Chromatic を使って、コンポーネントの早期レビュー
- Truncateなどのエッジケースを story にすることで、リグレッションテストが可能に
- デザイナーさんとの連携がしやすくなる

## 最後に

3ヶ月経った時点での技術選定とディレクトリ構成の振り返りをしてみましたが、大部分がうまくいっていると感じています。
ただ、今のところ導入時からdecision makeを一緒にやってきた二人で開発をしているのでスムーズに出来ている点もあると思います。
今月から、新しいメンバーが本プロジェクトに参画するので、新しい視点でのフィードバックがあると思うので、今後もより良いアプリケーションづくりをしていきたいと思います。

読んでいただきありがとうございました。

-------------------

- TypeScript初心者だったけど、開発スピードがそこまで落ちたとは感じなかった
- メンターとして入ってくれている、TypeScript経験のある外部のエンジニアがいたので、困ったときは聞けたり、TypeScriptの正しい使い方ができていると思う
- TypeScriptのおかげで開発中に型の不一致などのバグを早期発見できるのはやはり良い
- 速い！DXが改善されたのは実感する
- ここは悩んだところだったけど、今のところ大きな問題なし
- Recoilについては興味あるので、どっかのタイミングで試してみる
- ドキュメントはExampleがあって便利だけど、深い説明まではない印象で、最初は理解するのに時間がかかった
- ヘッドレスだから、スタイリングが自由にできるのは良し。一度UIコンポーネントを作ってしまえば、それ以降のテーブルの開発は時間がかからないし
- Paginationを最近追加したけど、やりやすかった
- Editableなテーブルは、次の機能開発で使うつもりだから楽しみ。使いやすいことを期待
- 今までのBEMでの運用と比べて、classNameのネーミングを機にする必要がなくなったことは良い点
- 最近の進化が著しいCSSはもはや何の文句もない感じ
- 時と場合によっては、css-in-jsを使う二刀流をしている
- スタイルが少なく単純な場合は、tsファイルにcss-in-jsで書いた方がスタイリングも見通しも良くなって良し
- vulnerabilityへの対応をするようになった
- どこのmodelに属するのか迷う場面が最初はあったけれど、だんだん判断がつくようになってきた
- 階層の深さが読めるのは良し
- 階層が浅くなったぶん、同階層に多くのフォルダが生まれるようになったけど、そもそもファイルの検索でファイルは探すし、一覧性って意味ではやはりメリットがあると思う。
- サードパーティのライブラリを使うときは、インターフェースを設けておく
- eslintで直接インポートするのを警告する
- ファイルの移動がない
- barrelの採用は大成功。
- エリアスでのDirect path importは、かなり良い。コードのコピペの際にいちいち相対パスを書き換える必要がなくなったことはかなり便利
- react-hook-form
- フォームの多いアプリケーション
- 非制御コンポーネントとして実装する必要があるので、ライブラリに依存したコンポーネント実装になってしまうところがちょっとと思っている
- フォームステートの管理とバリデーションが楽になるのはすごく良い
- zod
- バリデーションの型定義が楽
- テーブルライブラリ以外にもzodの利用方法はありそうなので、今後勉強したい
- Recoil
- 分散型のステート管理をしているのは魅力的
- Context APIはパフォーマンスを気にしてContextを分けるなど、使いやすいとは言えないからそこら辺が解消されたら
- ラーニングカーブはあると聞いたことがあるのでそこら辺が大丈夫か試してみようと思う
- Storybook
- デザイナーさんとのコミュニケーションが捗りそう
- ビジュアルテストもできるのは良い